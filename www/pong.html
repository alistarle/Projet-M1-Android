<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">
    <link href="css/styleGame.css" rel="stylesheet">
    <script src="js/phaser.min.js"></script>
    <script src="js/gyro.js"></script>
    <script src="js/options.js"></script>
    <title>Hello World</title>
</head>

<body>
    <script type="text/javascript">
    window.onload = function() {
        var modeControle = optionsGetModeControle();
        //variable game avec resolution
        var game = new Phaser.Game(1080, 1920, Phaser.AUTO, '', {
            preload: preload,
            create: create,
            update: update
        });

        //couleurs
        var BallColor = 0xff00ff;
        var BetPlayer1Color  = 0x00ffff;
        var BetPlayer2Color = 0x5522ff;
        var backgroundColor = 0xffffff;

        //skins
        var skinPlayer1Path='assets/skins/moustache.png';
        var skinPlayer2Path='assets/skins/yeux.png'

        //variable de coordonees 
        var marge = 80;
        var Y = 1000;

        //scores
        var scorePlayer;
        var scoreCompute0;

        //gameObjects
        var playerBet;
        var computerBet;
        var ball;

        var scoreText;

        //valeurs pouvant Ãªtre modifiees
        var computerBetSpeed = 400;
        var ballSpeed = 500;
        var ballReleased = false;

        function preload() {
            //chargement des assets
            game.load.image('bet', 'assets/bet.png');
            game.load.image('ball', 'assets/ball.png');
            game.load.bitmapFont('font', 'assets/flappyfont.png', 'assets/flappyfont.fnt');
            game.load.bitmapFont('flappyfont', 'assets/flappyfont.png', 'assets/flappyfont.fnt');
            game.load.image('skinPlayer1',skinPlayer1Path);
            game.load.image('skinPlayer2',skinPlayer2Path);

        }


        function create() {

            game.scorePlayer = 0;
            game.scoreComputer = 0;
            //OnCreate initialisation des objets avec sprites et physique
            game.physics.startSystem(Phaser.Physics.ARCADE);
            game.stage.backgroundColor = backgroundColor;
            playerBet = createBetBot();
            computerBet = createBetTop();
            ball = game.add.sprite(game.world.centerX, game.world.centerY, 'ball');


            ball.tint = BallColor;
            game.physics.arcade.enable(ball);

            ball.anchor.setTo(0.5, 0.5);
            ball.body.collideWorldBounds = true;
            ball.body.bounce.setTo(1, 1);
            game.input.onDown.add(releaseBall, this);

            game.scoreText = game.add.bitmapText(game.width / 2 - 230, 0, 'flappyfont', game.scorePlayer.toString() + ":" + game.scoreComputer.toString(), 50);
            game.scoreText.visible = true;

            this.scale.scaleMode = Phaser.ScaleManager.EXACT_FIT;


            //create an emitter
            emitter = game.add.emitter(game.world.centerX, game.world.centerY, 400);
            emitter.makeParticles('ball');
            emitter.forEach(function(particle) {
            // tint every particle red
            particle.tint = BallColor;
            });

            emitter.gravity = 200;
            emitter.setAlpha(1, 0, 20);
            emitter.setScale(1, 0, 1, 0, 400);

            emitter.start(false, 30, 5);

            if (modeControle == 2) {
                gyro.frequency = 2;
                gyro.startTracking(function(o) {
                    var gyroX = o.gamma * 15 + game.width / 2;
                    if (gyroX > 0 && gyroX < game.width) {
                        playerBet.x = gyroX;
                    }

                });
            }

            this.scale.startFullScreen(false);


        }

        function trail() {
            var px = ball.body.velocity.x;
            var py = ball.body.velocity.y;

            px *= -1;
            py *= -1;
            emitter.emitX = ball.x;
            emitter.emitY = ball.y;

            emitter.minParticleSpeed.set(px, py);
            emitter.maxParticleSpeed.set(px, py);
        }

        function createBetTop() {
            //creer une raquette
            var bet = game.add.sprite(game.world.centerX,  marge, 'bet');
            game.physics.arcade.enable(bet);
            bet.anchor.setTo(0.5, 0.5);
            bet.body.collideWorldBounds = true;
            bet.body.bounce.setTo(1, 1);
            bet.body.immovable = true;
            bet.tint = BetPlayer2Color;

            var skin = game.add.sprite(-100,-20 , 'skinPlayer2');

            bet.addChild(skin);
            return bet;
        }

        function createBetBot() {
            //creer une raquette
            var bet = game.add.sprite(game.world.centerX, game.height - marge, 'bet');
            game.physics.arcade.enable(bet);
            bet.anchor.setTo(0.5, 0.5);
            bet.body.collideWorldBounds = true;
            bet.body.bounce.setTo(1, 1);
            bet.body.immovable = true;
            bet.tint = BetPlayer1Color;

            var skin = game.add.sprite(-100,-20 , 'skinPlayer1');

            bet.addChild(skin);
            return bet;
        }



        function releaseBall() {
            if (!ballReleased) {
                ball.body.velocity.x = ballSpeed;
                ball.body.velocity.y = -ballSpeed;
                ballReleased = true;
            }
        }

        function checkGoal() {
            //si but alors score++
            if (ball.y < marge) {
                setBall();
                game.scorePlayer++;
            } else if (ball.y > game.height - marge) {
                setBall();
                game.scoreComputer++;
            }
            updateScore();
        }

        function updateScore() {
            //refresh affichage du score
            game.scoreText.setText("player " + game.scorePlayer.toString() + " : " + game.scoreComputer.toString() + " computer");
        }

        function setBall() {
            //balle au centre
            if (ballReleased) {
                ball.x = game.world.centerX;
                ball.y = game.world.centerY;
                ball.body.velocity.x = 0;
                ball.body.velocity.y = 0;
                ballReleased = false;
            }
        }

        function ballHitsBet(_ball, _bet) {
            //physique balle+raquette
            var diff = 0;

            //gauche
            if (_ball.x < _bet.x) {
                diff = _bet.x - _ball.x;
                _ball.body.velocity.x = (-10 * diff);
                //droite
            } else if (_ball.x > _bet.x) {
                diff = _ball.x - _bet.x;
                _ball.body.velocity.x = (10 * diff);
            } else {
                //The ball hit the center of the racket, let's add a little bit of a tragic accident(random) of his movement
                _ball.body.velocity.x = 2 + Math.random() * 8;
            }
        }

        function update() {
            //control par le joueur

            //CONTROL CLASSIQUE

            if (modeControle == 1) {
                playerBet.x = game.input.x;


                var playerBetHalfWidth = playerBet.width / 2;

                if (playerBet.x < playerBetHalfWidth) {
                    playerBet.x = playerBetHalfWidth;
                } else if (playerBet.x > game.width - playerBetHalfWidth) {
                    playerBet.x = game.width - playerBetHalfWidth;
                }
            }
            trail();

            //control par IA
            if (computerBet.x - ball.x < -15) {
                computerBet.body.velocity.x = computerBetSpeed;
            } else if (computerBet.x - ball.x > 15) {
                computerBet.body.velocity.x = -computerBetSpeed;
            } else {
                computerBet.body.velocity.x = 0;
            }
            if(ballReleased){
                emitter.emitParticle();
            }


            //check des collisions
            game.physics.arcade.collide(ball, playerBet, ballHitsBet, null, this);
            game.physics.arcade.collide(ball, computerBet, ballHitsBet, null, this);
            checkGoal();


        }
    };
    </script>
</body>

</html>
